define("lytix_measure/gauge",["exports","core/templates","lytix_helper/widget","lytix_logs/logs"],(function(_exports,_templates,_widget,_logs){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_templates=_interopRequireDefault(_templates),_widget=_interopRequireDefault(_widget);var GAP_SIZE=2*Math.PI*.333,GAP_OFFSET=GAP_SIZE/2,MAX_ARC=2*Math.PI-GAP_SIZE,viewBox={min:-50,length:100,height:95},view={viewBox:viewBox,arcs:new Array(3),strokeWidth:5.05,captions:new Array(3),labels:[]},radius=(viewBox.length-5)/2,polarToCartesian=function(radius,angle){return{x:radius*Math.cos(angle),y:radius*Math.sin(angle)}},calculateSvgArc=function(startAngle,endAngle){return{radius:radius,start:polarToCartesian(radius,startAngle),end:polarToCartesian(radius,endAngle)}},calculateDashData=function(radius,fraction){var fullLength=2*radius*Math.PI*.667;return{fullLength:fullLength,length:fullLength*(1-fraction)}};_exports.init=function(contextid,courseid,userid,isteacher){var log=(0,_logs.makeLoggingFunction)(userid,courseid,contextid,"measure"),stringsPromise=_widget.default.getStrings({lytix_measure:{identical:["hello","personal_dashboard","unlocked_activities","total_students","number_previous_activities","number_open_activities","mine","lowest","highest","avg","total","summary"]}}),dataPromise=_widget.default.getData("local_lytix_lytix_measure_measure_get",{contextid:contextid,courseid:courseid,userid:userid}).then((function(data){var scores=data.Scores,keys=scores.keys=["Highest","Avg",isteacher?"Lowest":"Mine"],fractions=scores.fractions=new Array(scores.Activity.length);return scores.currentFractions=null,scores.updateActivityFractions=function(index){if(!fractions[index]){fractions[index]=new Array(3);for(var max=scores.Max[index],i=0;i<3;++i)fractions[index][i]=scores[keys[i]][index]/max}scores.currentFractions=fractions[index]},scores.updateActivityFractions(0),data}));Promise.all([stringsPromise,dataPromise]).then((function(values){var strings=view.strings=values[0],data=values[1],scores=data.Scores,currentFractions=scores.currentFractions;view.isteacher=isteacher,isteacher?(view.StudentCount=data.StudentCount,view.ActivityCount=data.ActivityCount):view.name=data.Name,view.total=strings.total;for(var START_ANGLE=Math.PI/2+GAP_OFFSET,i=0;i<3;++i){var score=currentFractions[i],endAngle=START_ANGLE+MAX_ARC;(view.arcs[i]=calculateSvgArc(START_ANGLE,endAngle)).dash=calculateDashData(radius,score),radius-=5}for(var startCoordinates=polarToCartesian(radius,START_ANGLE),_i=2;_i>=0;--_i)view.captions[2-_i]={text:strings[scores.keys[_i].toLowerCase()],value:Math.round(100*currentFractions[_i]),yShift:2.5-_i,xShift:-(2-_i),x:startCoordinates.x,y:startCoordinates.y};radius=(viewBox.length-5)/2-5,view.base=calculateSvgArc(START_ANGLE,START_ANGLE+MAX_ARC),view.base.strokeWidth=15;var needleIndex=isteacher?1:2,point=polarToCartesian(28,START_ANGLE);view.needle={r:5,x:point.x,y:point.y,angle:240.12*currentFractions[needleIndex]};var activities=scores.Activity,count=activities.length-1;view.filter=new Array(count);for(var _i2=0;_i2<count;++_i2)view.filter[_i2]={label:activities[_i2+1],activityIndex:_i2+1};return _templates.default.render("lytix_measure/gauge",view).then((function(html){var container=document.getElementById("gauge");container.innerHTML=html;var gauge=container.querySelector("svg");new ResizeObserver((function(){var rect=gauge.getBoundingClientRect(),factor=1;rect.width<270?factor=.6:rect.width<280?factor=.7:rect.width<370&&(factor=.9),gauge.style.fontSize=viewBox.length/rect.height*factor+"rem"})).observe(container);var needle=container.querySelector(".needle line"),arcElements=container.querySelectorAll(".arcs path"),captions=container.querySelectorAll(".caption .value");document.getElementById("gauge-filter").addEventListener("change",(function(event){var activityIndex=event.target.dataset.activityindex;scores.updateActivityFractions(activityIndex),log("FILTER","ON",scores.Activity[activityIndex]);for(var _i3=0;_i3<3;++_i3){var arcElement=arcElements[_i3],_arcData=view.arcs[_i3],fraction=scores.currentFractions[_i3],length=_arcData.dash.fullLength*(1-fraction);arcElement.setAttribute("stroke-dashoffset",length),captions[2-_i3].innerHTML=Math.round(100*fraction)}var needleAngle=240.12*scores.currentFractions[needleIndex];needle.setAttribute("transform","rotate("+needleAngle+")")}))}))})).catch((function(err){return window.console.debug(err)}))}}));

//# sourceMappingURL=gauge.min.js.map